<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="路由器上配置科学上网 & DNS 优化。"><title>AdGuardHome + mosdns + openclash 打造自由的家庭/办公室网络</title><link rel=canonical href=https://www.wegod.cc/p/fuck-gfw/><link rel=stylesheet href=/scss/style.min.ebd33182d80f4c09ca68afdd59bcc91a2568c867933c6f27103abdeb5f9726d6.css><meta property='og:title' content="AdGuardHome + mosdns + openclash 打造自由的家庭/办公室网络"><meta property='og:description' content="路由器上配置科学上网 & DNS 优化。"><meta property='og:url' content='https://www.wegod.cc/p/fuck-gfw/'><meta property='og:site_name' content='小甲哥の垃圾工厂'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='adGuardHome'><meta property='article:tag' content='gfw'><meta property='article:tag' content='clash'><meta property='article:tag' content='openclash'><meta property='article:tag' content='mosdns'><meta property='article:tag' content='ss'><meta property='article:tag' content='helloworld'><meta property='article:tag' content='tag'><meta property='article:tag' content='chickenrun'><meta property='article:tag' content='小鸡快跑'><meta property='article:tag' content='机场'><meta property='article:tag' content='梯子'><meta property='article:tag' content='科学上网'><meta property='article:tag' content='翻墙'><meta property='article:published_time' content='2023-11-25T20:32:18+08:00'><meta property='article:modified_time' content='2025-12-03T15:13:48+00:00'><meta property='og:image' content='https://www.wegod.cc/p/fuck-gfw/cover.jpg'><meta name=twitter:title content="AdGuardHome + mosdns + openclash 打造自由的家庭/办公室网络"><meta name=twitter:description content="路由器上配置科学上网 & DNS 优化。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://www.wegod.cc/p/fuck-gfw/cover.jpg'><link rel="shortcut icon" href=/favicon.ico><script src=https://code.jquery.com/jquery-latest.min.js crossorigin=anonymous></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu_d559e44e4681e833.gif width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>小甲哥の垃圾工厂</a></h1><h2 class=site-description>挖坑埋雷 甩锅推诿</h2></div></header><ol class=menu-social><li><a href=https://github.com/alecthw target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://t.me/alecthw target=_blank title=Telegram rel=me><svg class="icon icon-tabler icon-tabler-brand-telegram" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M15 10l-4 4 6 6 4-16-18 7 4 2 2 6 3-4"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>主页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/book/><svg class="icon icon-tabler icon-tabler-book" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 19a9 9 0 019 0 9 9 0 019 0"/><path d="M3 6a9 9 0 019 0 9 9 0 019 0"/><line x1="3" y1="6" x2="3" y2="19"/><line x1="12" y1="6" x2="12" y2="19"/><line x1="21" y1="6" x2="21" y2="19"/></svg>
<span>书籍</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>链接</span></a></li><li><a href=https://558343.dedicated-afflink.com/#/auth/2neqgxFl target=_blank><svg class="icon icon-tabler icon-tabler-flame" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 12c2-2.96.0-7-1-8 0 3.038-1.773 4.741-3 6-1.226 1.26-2 3.24-2 5a6 6 0 1012 0c0-1.532-1.056-3.94-2-5-1.786 3-2.791 3-4 2z"/></svg>
<span>TAG</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#前言>前言</a><ol><li><a href=#路由器科学上网和终端科学上网的区别>路由器科学上网和终端科学上网的区别</a><ol><li><a href=#pc终端上>PC终端上</a></li><li><a href=#路由器上配置透明代理>路由器上配置透明代理</a></li></ol></li></ol></li><li><a href=#正文开始配置--dns-优化>正文开始：配置 & DNS 优化</a><ol><li><a href=#国内外和应用分流>国内外和应用分流</a></li><li><a href=#dns-优化目标>DNS 优化目标</a></li><li><a href=#多级-dns-级联>多级 DNS 级联</a></li><li><a href=#配置示例>配置示例</a><ol><li><a href=#dnsmasq>dnsmasq</a></li><li><a href=#adguardhome>AdGuardHome</a></li><li><a href=#openclash>openclash</a></li><li><a href=#mosdns>mosdns</a></li><li><a href=#防火墙劫持-53-端口可选>防火墙，劫持 53 端口（可选）</a></li></ol></li></ol></li><li><a href=#作为主路由时使用的特别说明>作为主路由时使用的特别说明</a><ol><li><a href=#主路由-dhcp-服务器>主路由 DHCP 服务器</a></li><li><a href=#主路由-ipv6>主路由 IPv6</a></li></ol></li><li><a href=#作为旁路由时使用的特别说明>作为旁路由时使用的特别说明</a><ol><li><a href=#旁路由-dhcp-服务器>旁路由 DHCP 服务器</a></li><li><a href=#旁路由-ipv6>旁路由 IPv6</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/fuck-gfw/><img src=/p/fuck-gfw/cover_hu_8b687cd66f4fe79.jpg srcset="/p/fuck-gfw/cover_hu_8b687cd66f4fe79.jpg 800w, /p/fuck-gfw/cover_hu_a8b5b44a2414569b.jpg 1600w" width=800 height=300 loading=lazy alt="Featured image of post AdGuardHome + mosdns + openclash 打造自由的家庭/办公室网络"></a></div><div class=article-details><header class=article-category><a href=/categories/passgfw/>科学上网</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/fuck-gfw/>AdGuardHome + mosdns + openclash 打造自由的家庭/办公室网络</a></h2><h3 class=article-subtitle>路由器上配置科学上网 & DNS 优化。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published datetime=2023-11-25T20:32:18+08:00>2023-11-25 20:32</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 7 分钟</time></div></footer></div></header><section class=article-content><p>🔥🔥🔥：稳定好用的机场/梯子 <a class=link href=https://558343.dedicated-afflink.com/#/auth/2neqgxFl target=_blank rel=noopener>TAG 全球250+节点、99+流媒体解锁</a>，更多参考<a class=link href=/p/airport-recommend/>机场推荐</a></p><hr><p>👉 首先推广下自己编译的 OpenWrt <strong>旁路由极简版</strong>，专为<strong>旁路由</strong>而制作。 👍👍👍</p><ul><li>编译脚本以及个人修改的组件依赖全开源，Github Actions 在线编译，安全可靠无后门。</li><li>基于 <a class=link href=https://github.com/coolsnowwolf/lede target=_blank rel=noopener>lede</a> 源码</li><li>默认配置 DHCPv6 Client 接口 lan6。</li><li>默认配置好了 AdGuardHome 、 mosdns 和 openclash （或 ssrp ）的搭配运行配置。</li><li>openclash 预置 clash_meta 内核。</li><li>mosdns 使用了 <a class=link href=https://github.com/alecthw/mosdns target=_blank rel=noopener>自己的修改版</a>，支持 MMDB GeoIP 匹配。</li></ul><div class=table-wrapper><table><thead><tr><th>版本</th><th>说明</th><th style=text-align:center>下载地址</th></tr></thead><tbody><tr><td>x86</td><td>包含 ssrp 和 openclash，<a class=link href=https://github.com/alecthw/openwrt-actions/blob/master/user/lede-common-x86-amd64/README.md target=_blank rel=noopener>详细说明</a></td><td style=text-align:center><a class=link href=https://github.com/alecthw/openwrt-actions/releases/tag/lede-common-x86-amd64 target=_blank rel=noopener>下载</a></td></tr><tr><td>x86 openclash 专版</td><td>仅包含 openclash，注意此固件默认不劫持 53 端口，<a class=link href=https://github.com/alecthw/openwrt-actions/blob/master/user/lede-openclash-x86-amd64/README.md target=_blank rel=noopener>详细说明</a></td><td style=text-align:center><a class=link href=https://github.com/alecthw/openwrt-actions/releases/tag/lede-openclash-x86-amd64 target=_blank rel=noopener>下载</a></td></tr><tr><td>r2s</td><td>包含 ssrp 和 openclash，<a class=link href=https://github.com/alecthw/openwrt-actions/blob/master/user/lede-common-r2s-arm64/README.md target=_blank rel=noopener>详细说明</a></td><td style=text-align:center><a class=link href=https://github.com/alecthw/openwrt-actions/releases/tag/lede-common-r2s-arm64 target=_blank rel=noopener>下载</a></td></tr><tr><td>n1</td><td>包含 ssrp 和 openclash，<a class=link href=https://github.com/alecthw/openwrt-actions/blob/master/user/lede-common-n1-arm64/README.md target=_blank rel=noopener>详细说明</a></td><td style=text-align:center><a class=link href=https://github.com/alecthw/openwrt-actions/releases/tag/lede-common-n1-arm64 target=_blank rel=noopener>下载</a></td></tr></tbody></table></div><p><strong>注意，旁路由固件默认未开启DHCP，旁路由固件默认未开启DHCP，旁路由固件默认未开启DHCP！</strong></p><p><strong>所以，如果不在控制台修改IP，请修改电脑的IP访问，然后可以在网页修改。</strong></p><h2 id=前言>前言</h2><p>CN网络的阻断方式主要有两个部分：</p><ul><li>GFW 阻断</li><li>DNS 污染</li></ul><p>GFW 阻断就是我们常说的<code>被墙了</code>，即使是DNS没有被污染，也无法访问到。</p><p>DNS 污染即让你访问网站时，无法获得域名对应的IP地址，从而导致无法访问到网站。DNS 污染在移动宽带中尤为典型，即使自定义了DNS 服务器，也会被拦截污染。</p><p>要实现科学上网，必须同时解决<code>GFW 阻断</code>和<code>DNS 污染</code>，并且两者配合以提高网络访问体验。</p><p>代理中的DNS知识，可以参考 Sukka 的这篇文章<a class=link href=https://blog.skk.moe/post/what-happend-to-dns-in-proxy/ target=_blank rel=noopener>《浅谈在代理环境中的 DNS 解析行为》</a></p><h3 id=路由器科学上网和终端科学上网的区别>路由器科学上网和终端科学上网的区别</h3><p>路由器上配置透明代理，和在终端PC上直接通过客户端，最主要的区别是 DNS 解析。</p><h4 id=pc终端上>PC终端上</h4><p>通常有以下几个步骤</p><ol><li>启动客户端</li><li>选择全局/规则模式</li><li>配置系统代理（一般客户端自动配置），把科学上网客户端作为系统代理的上游代理服务器</li></ol><p>第3步里的配置系统代理，通常有<code>http</code>和<code>sock5</code>两种。</p><p>此时，打开浏览器访问一个网站：</p><p>当使用<code>http</code>代理时，浏览器不会在本地进行 DNS 解析，请求的域名会作为 http 报文的一部分直接发给代理服务器（科学上网客户端），DNS 完全在代理服务器（科学上网客户端）上处理。</p><p>当使用<code>sock5</code>代理时，<code>sock5</code>支持UDP，DNS 解析会封装在<code>sock5</code>之中，发给代理服务器（科学上网客户端）处理，浏览器拿到 IP 地址后，在发起连接。</p><h4 id=路由器上配置透明代理>路由器上配置透明代理</h4><p>此时，科学上网客户端运行在路由器上，PC 终端是看不见代理的，所以叫透明代理。PC 终端上，请求的发起的流程照旧，先进行 DNS 解析，拿到 IP 后再发起请求。</p><p>在这种情况下，对于路由器上运行的科学上网客户端来说，域名和 IP 是两个请求，有的会内置 Mapping 机制（例如 Clash），用来还原 IP 到域名。</p><p>这种情况下，优惠DNS配置就相对比较重要了，否则针对部署的CDN的网站不能做到最优访问。</p><h2 id=正文开始配置--dns-优化>正文开始：配置 & DNS 优化</h2><p>本文主要考虑的是自由的局域网环境，所以只介绍路由器上科学上网配置。</p><p>首先分析下要实现的目标：</p><ul><li>双栈网络<ul><li>国内网络使用 IPV4 & IPV6 双栈</li><li>科学上网仅使用 IPV4</li></ul></li><li>国内外分流</li><li>DNS分流<ul><li>国内域名由国内 DNS 服务器解析</li><li>国外域名经过代理由国外 DNS 服务器</li></ul></li></ul><h3 id=国内外和应用分流>国内外和应用分流</h3><p>这个没啥好多说的，按文档配置规则就行。也可参考文末给出的示例配置。</p><h3 id=dns-优化目标>DNS 优化目标</h3><ul><li>广告过滤：使用 AdGuardHome</li><li>DNS分流：使用 mosdns<ul><li>其中，境外网站屏蔽 IPV6 应答</li></ul></li><li>如果使用 openclash，DNS 必须经过 clash 内核，以使 DNS 完成 IP &lt;&ndash;> Domain 的 mapping</li></ul><p>PS: mosdns 使用 <a class=link href=https://github.com/alecthw/mosdns target=_blank rel=noopener>alecthw 修改版</a>，支持 MMDB GeoIP 匹配</p><h3 id=多级-dns-级联>多级 DNS 级联</h3><pre class=mermaid>flowchart LR
    A[AdGuardHome, Port 53, no cache] -- 主要 --&gt; B[openclash, Port 7874]
    B --&gt; C[mosdns, Port 5335]
    A -- 备用\n防止 openclash 为运行时网络无法访问 --&gt; C</pre><p>配置过程如下：</p><ul><li>修改了 dnsmasq 的默认端口号，用 AdGuardHome 监听53端口作为默认的DNS解析。</li><li>AdGuardHome 可以监控的各个终端的 DNS 请求，并使用广告过滤和管控功能。</li><li>openclash 作为 AdGuardHome 的上游。</li><li>mosdns 作为 AdGuardHome 的上游备用服务器。</li><li>openclash 中<code>本地 DNS 劫持</code>设置为<code>停用</code>，当 openclash 运行时，openclash 作为 AdGuardHome 的上游主要服务器<code>生效</code>。</li><li>openclash 复写设置中，启用自定义上游 DNS 服务器，并指定 mosdns 为唯一上游。</li></ul><p>如此一来，最终的 DNS 请求由 mosdns 发出，请求会经过 openclash 分流，按请求的 DNS 服务器直连或走代理。DNS 请求整个流程如下：</p><pre class=mermaid>flowchart TB
    A((电脑/手机\n浏览器)) -- DNS 请求 --&gt; B[路由器\nAdGuardHome]
    B --&gt; C[路由器\nopenclash DNS]
    C --&gt; D[路由器\nmosdns]
    D --&gt; E[路由器\nopenclash Proxy Client]
    E -- 国外 DNS 服务器\n屏蔽ipv6应答 --&gt; F[服务器\nProxy Server]
    E -- 国内 DNS 服务器 --&gt; N(Internet)
    F --&gt; N</pre><p>如此，便实现了</p><ul><li>AdGuardHome 的管控和广告过滤</li><li>mosdns 分流 DNS，并屏蔽非中国大陆 IP 的 IPV6 应答</li><li>DNS 经过 clash 内核，迎合其 mapping 机制</li></ul><h3 id=配置示例>配置示例</h3><p>👍 再次提醒，文章开始处的固件，所有配置已内置哦！</p><h4 id=dnsmasq>dnsmasq</h4><p><img src=/p/fuck-gfw/dnsmasq.png width=1453 height=84 srcset="/p/fuck-gfw/dnsmasq_hu_55e25a4cd64de615.png 480w, /p/fuck-gfw/dnsmasq_hu_10009cc241eca1f6.png 1024w" loading=lazy alt=dnsmasq class=gallery-image data-flex-grow=1729 data-flex-basis=4151px></p><h4 id=adguardhome>AdGuardHome</h4><p><img src=/p/fuck-gfw/adguardhome_1.png width=1424 height=197 srcset="/p/fuck-gfw/adguardhome_1_hu_2cf26687e88d5e37.png 480w, /p/fuck-gfw/adguardhome_1_hu_8397c7c813616ae1.png 1024w" loading=lazy alt=adguardhome_1 class=gallery-image data-flex-grow=722 data-flex-basis=1734px></p><p><img src=/p/fuck-gfw/adguardhome_2.png width=1427 height=440 srcset="/p/fuck-gfw/adguardhome_2_hu_bd4ea69b47c86176.png 480w, /p/fuck-gfw/adguardhome_2_hu_55cebf092f58ccb2.png 1024w" loading=lazy alt=adguardhome_2 class=gallery-image data-flex-grow=324 data-flex-basis=778px></p><h4 id=openclash>openclash</h4><p><img src=/p/fuck-gfw/openclash_1.png width=1731 height=246 srcset="/p/fuck-gfw/openclash_1_hu_4f39d226cd74ea6d.png 480w, /p/fuck-gfw/openclash_1_hu_94961e8467752b8b.png 1024w" loading=lazy alt=openclash_1 class=gallery-image data-flex-grow=703 data-flex-basis=1688px></p><p><img src=/p/fuck-gfw/openclash_2.png width=1745 height=293 srcset="/p/fuck-gfw/openclash_2_hu_8457efb58deb5623.png 480w, /p/fuck-gfw/openclash_2_hu_6889f5779b2dcd9a.png 1024w" loading=lazy alt=openclash_2 class=gallery-image data-flex-grow=595 data-flex-basis=1429px></p><p>注意删除默认的DNS配置，仅保留这一个即可。</p><h4 id=mosdns>mosdns</h4><p>使用自定义配置，由于使用了 mmdb geoip 匹配，mosdns 必须使用 <a class=link href=https://github.com/alecthw/mosdns target=_blank rel=noopener>alecthw 修改版</a>。</p><p>PS: 以下配置中的 <a class=link href=https://github.com/alecthw/chnlist/blob/release/mosdns/whitelist.list target=_blank rel=noopener>cn-white.txt</a>，来自项目 <a class=link href=https://github.com/alecthw/chnlist target=_blank rel=noopener>chnlist</a>，我编译的固件已内置并设置自动更新，其他固件需要手动下载。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=c># 白名单模式</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c># 白名单 或 境外查询IP是geoip:CN，走国内</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>log</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>level</span><span class=p>:</span><span class=w> </span><span class=l>info</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/tmp/mosdns.log&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>plugins</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># mmdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>country</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>mmdb</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/mosdns/rule/Country.mmdb&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># cn ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>whitelist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>domain_set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/etc/mosdns/rule/cn-white.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 广告域名列表 geosite:category-ads-all</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>geosite_ads</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>domain_set</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>files</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;/etc/mosdns/rule/reject-list.txt&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>entries</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=s2>&#34;localhost 127.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 缓存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=m>20480</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>lazy_cache_ttl</span><span class=p>:</span><span class=w> </span><span class=m>86400</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dump_file</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;/etc/mosdns/cache.dump&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>dump_interval</span><span class=p>:</span><span class=w> </span><span class=m>1800</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 查询境外DNS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>forward_global</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>forward</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>concurrent</span><span class=p>:</span><span class=w> </span><span class=m>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>upstreams</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>Google_dot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls://8.8.4.4&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>enable_pipeline</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>Quad9_dot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls://9.9.9.9&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>enable_pipeline</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>Cloudflare_dot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls://1.0.0.1&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>enable_pipeline</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>OpenDNS_dot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls://208.67.222.222&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>enable_pipeline</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 查询国内DNS</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>forward_china</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>forward</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>concurrent</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>upstreams</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>Ali_dot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls://223.5.5.5&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>enable_pipeline</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>DNSPod_dot</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>addr</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;tls://120.53.53.53&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>          </span><span class=nt>enable_pipeline</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 境外解析，优先IPV4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>global_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>qname $whitelist</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>return</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>prefer_ipv4</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$forward_global</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>resp_ip_mmdb $country CN</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>drop_resp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 国内解析，不设置过滤，作为fallback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>china_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$forward_china</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 屏蔽解析</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>reject_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>qname $geosite_ads</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>reject 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>qtype 12</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>reject 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c># - matches: qtype 65</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=c>#   exec: reject 3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 如果 primary 抛出错误，或返回但没有应答，或在 threshold 毫秒内无响应，则执行 secondary。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># 所以在 primary 中不能用 rejcet，reject 也是应答</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=c># Fallback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>fallback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>fallback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>primary</span><span class=p>:</span><span class=w> </span><span class=l>global_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>secondary</span><span class=p>:</span><span class=w> </span><span class=l>china_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>threshold</span><span class=p>:</span><span class=w> </span><span class=m>150</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>always_standby</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>main_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$reject_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$hosts</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>has_resp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>accept</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$cache</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>has_resp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>accept</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>$fallback</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span>- <span class=nt>matches</span><span class=p>:</span><span class=w> </span><span class=l>has_resp</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=nt>exec</span><span class=p>:</span><span class=w> </span><span class=l>ttl 10-600</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span>- <span class=nt>tag</span><span class=p>:</span><span class=w> </span><span class=l>udp_server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>udp_server</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>args</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>entry</span><span class=p>:</span><span class=w> </span><span class=l>main_sequence</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>5335</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><h4 id=防火墙劫持-53-端口可选>防火墙，劫持 53 端口（可选）</h4><p>防止客户端自定义 DNS 服务器，从而绕过管控，可以在防火墙自定义规则配置劫持 53 端口 UDP 和 UDP。</p><p>但是，如果客户端配置加密 DNS 就没法劫持。如果要限制，对于 DoT 和 DoQ 可以屏蔽 853 端口禁用，但是 DoH 就完全没办法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># 同时支持 iptables 和 ip6tables</span>
</span></span><span class=line><span class=cl>dns_redirect<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=nv>cmd</span><span class=o>=</span><span class=s2>&#34;-t nat -A PREROUTING -p </span><span class=nv>$1</span><span class=s2> --dport 53 -j REDIRECT --to-ports 53&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nv>chk</span><span class=o>=</span><span class=k>$(</span><span class=nb>echo</span> <span class=nv>$cmd</span> <span class=p>|</span> sed -e <span class=s1>&#39;s/-A/-C/g&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$cmd</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=nv>$chk</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$2</span> <span class=nv>$chk</span>
</span></span><span class=line><span class=cl>    <span class=nv>ret</span><span class=o>=</span><span class=nv>$?</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$ret</span><span class=s2>&#34;</span> -ne <span class=m>0</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>        <span class=nv>$2</span> <span class=nv>$cmd</span>
</span></span><span class=line><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>dns_redirect udp iptables
</span></span><span class=line><span class=cl>dns_redirect tcp iptables
</span></span><span class=line><span class=cl><span class=o>[</span> -n <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>command</span> -v ip6tables<span class=k>)</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> dns_redirect udp ip6tables
</span></span><span class=line><span class=cl><span class=o>[</span> -n <span class=s2>&#34;</span><span class=k>$(</span><span class=nb>command</span> -v ip6tables<span class=k>)</span><span class=s2>&#34;</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> dns_redirect tcp ip6tables
</span></span></code></pre></td></tr></table></div></div><h2 id=作为主路由时使用的特别说明>作为主路由时使用的特别说明</h2><h3 id=主路由-dhcp-服务器>主路由 DHCP 服务器</h3><p>DHCP 服务器设置中的 DNS 服务器，务必设置成旁路由，不要设置公共 DNS。</p><h3 id=主路由-ipv6>主路由 IPv6</h3><ol><li>不通告 IPv6 DNS 服务器，DNS 解析全部走 IPv4。</li><li>通告 DNS 服务器为路由器自己，即路由器的链路本地地址。</li></ol><h2 id=作为旁路由时使用的特别说明>作为旁路由时使用的特别说明</h2><h3 id=旁路由-dhcp-服务器>旁路由 DHCP 服务器</h3><p>一般情况下建议禁用旁路由 DHCP 服务器，在主路由配置 DHCP 服务器，把网关设置成旁路由，或者通过静态分配指定不同客户端指向不同网关。</p><p>DHCP 服务器设置中的 DNS 服务器，务必设置成旁路由，不要设置公共 DNS。</p><h3 id=旁路由-ipv6>旁路由 IPv6</h3><p>主路由上请勿通告 IPv6 DNS 服务器（这里指 IPv6 地址的 DNS 服务器，如 2400:3200::1）。通过 IPv4 地址的 DNS 服务器解析域名，一样可以拿到 AAAA 记录，所以没必要开启 IPv6 地址的 DNS 服务器，开启反而会增加配置难度，影响 DNS 分流，并可能造成 DNS 泄露。</p><p>如下查询示例，可以看到，通过 IPv4 DNS 服务器可以获得 IPv6 地址。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ nslookup www.iqiyi.com 223.5.5.5
</span></span><span class=line><span class=cl>Server:  223.5.5.5
</span></span><span class=line><span class=cl>Address: 223.5.5.5#53
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Non-authoritative answer:
</span></span><span class=line><span class=cl>www.iqiyi.com canonical <span class=nv>name</span> <span class=o>=</span> ipv6-static.dns.iqiyi.com.
</span></span><span class=line><span class=cl>Name:         ipv6-static.dns.iqiyi.com
</span></span><span class=line><span class=cl>Address: 101.227.12.45
</span></span><span class=line><span class=cl>Name:    ipv6-static.dns.iqiyi.com
</span></span><span class=line><span class=cl>Address: 101.227.12.41
</span></span><span class=line><span class=cl>Name:    ipv6-static.dns.iqiyi.com
</span></span><span class=line><span class=cl>Address: 240e:e1:a400:1c::22
</span></span><span class=line><span class=cl>Name:    ipv6-static.dns.iqiyi.com
</span></span><span class=line><span class=cl>Address: 240e:e1:a400:1c::21
</span></span></code></pre></td></tr></table></div></div><p>Openwrt、iKuai、RouterOS 都是支持不通告 IPv6 DNS 的。如果你的主路由不支持，IPv6 DNS 可以填个无效地址，如 <code>::1</code>。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/adguardhome/>AdGuardHome</a>
<a href=/tags/gfw/>Gfw</a>
<a href=/tags/clash/>Clash</a>
<a href=/tags/openclash/>Openclash</a>
<a href=/tags/mosdns/>Mosdns</a>
<a href=/tags/ss/>Ss</a>
<a href=/tags/helloworld/>Helloworld</a>
<a href=/tags/tag/>Tag</a>
<a href=/tags/chickenrun/>Chickenrun</a>
<a href=/tags/%E5%B0%8F%E9%B8%A1%E5%BF%AB%E8%B7%91/>小鸡快跑</a>
<a href=/tags/%E6%9C%BA%E5%9C%BA/>机场</a>
<a href=/tags/%E6%A2%AF%E5%AD%90/>梯子</a>
<a href=/tags/%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/>科学上网</a>
<a href=/tags/%E7%BF%BB%E5%A2%99/>翻墙</a></section><section class=article-lastmod><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<span>最后更新于 2025-12-03 15:13</span></section></footer></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/airport-recommend/><div class=article-image><img src=/p/airport-recommend/cover.d3d508b6e590ad5a33cca8f56d23e576_hu_1bcf64ae5b5a50ef.jpg width=250 height=150 loading=lazy alt="Featured image of post 机场/梯子推荐" data-key=airport-recommend data-hash="md5-09UItuWQrVozzKj1bSPldg=="></div><div class=article-details><h2 class=article-title>机场/梯子推荐</h2></div></a></article><article class=has-image><a href=/p/singbox-help-mobile/><div class=article-image><img src=/p/singbox-help-mobile/cover.83bac89a365137229733a99e5c6c3dec_hu_7801e10b1741986e.png width=250 height=150 loading=lazy alt="Featured image of post 手把手教你科学上网 —— 手机篇（sing-box）" data-key=singbox-help-mobile data-hash="md5-g7rImjZRNyKXM6meXGw97A=="></div><div class=article-details><h2 class=article-title>手把手教你科学上网 —— 手机篇（sing-box）</h2></div></a></article><article class=has-image><a href=/p/netflix-help/><div class=article-image><img src=/p/netflix-help/cover.5f9e08cc6eded8a1225fa9feb9a994af_hu_210f23254de4d159.jpg width=250 height=150 loading=lazy alt="Featured image of post 境外流媒体观看简单指南" data-key=netflix-help data-hash="md5-X54IzG7e2KEiX6n+uamUrw=="></div><div class=article-details><h2 class=article-title>境外流媒体观看简单指南</h2></div></a></article><article class=has-image><a href=/p/fuck-gfw-vxlan/><div class=article-image><img src=/p/fuck-gfw-vxlan/cover.9102a487229287a5998e850cffb3e718_hu_7241f41adfeb8537.png width=250 height=150 loading=lazy alt="Featured image of post Vxlan 是否能让 GFW 放松一点？Vxlan 搭建科学上网实验" data-key=fuck-gfw-vxlan data-hash="md5-kQKkhyKSh6WZjoUM/7PnGA=="></div><div class=article-details><h2 class=article-title>Vxlan 是否能让 GFW 放松一点？Vxlan 搭建科学上网实验</h2></div></a></article><article class=has-image><a href=/p/v2ray-tutorial/><div class=article-image><img src=/p/v2ray-tutorial/cover.83bac89a365137229733a99e5c6c3dec_hu_7801e10b1741986e.png width=250 height=150 loading=lazy alt="Featured image of post V2Ray4.x + Nginx + TLS + ws + MTProto 详细配置教程" data-key=v2ray-tutorial data-hash="md5-g7rImjZRNyKXM6meXGw97A=="></div><div class=article-details><h2 class=article-title>V2Ray4.x + Nginx + TLS + ws + MTProto 详细配置教程</h2></div></a></article></div></div></aside><script src=https://giscus.app/client.js data-repo=alecthw/alecthw.github.io data-repo-id=R_kgDOJYr3yg data-category=Announcements data-category-id=DIC_kwDOJYr3ys4CbogO data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=noborder_light data-lang=en data-loading crossorigin=anonymous async></script><script>function setGiscusTheme(e){let t=document.querySelector("iframe.giscus-frame");t&&t.contentWindow.postMessage({giscus:{setConfig:{theme:e}}},"https://giscus.app")}(function(){addEventListener("message",t=>{if(event.origin!=="https://giscus.app")return;e()}),window.addEventListener("onColorSchemeChange",e);function e(){setGiscusTheme(document.documentElement.dataset.scheme==="light"?"noborder_light":"noborder_gray")}})()</script><footer class=site-footer><section class=copyright>&copy;
2015 -
2025 小甲哥の垃圾工厂</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.32.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.c922af694cc257bf1ecc41c0dd7b0430f9114ec280ccf67cd2c6ad55f5316c4e.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script><style>.markmap>svg{width:100%;height:300px}</style><script>window.markmap={autoLoader:{manual:!0,onReady(){const{autoLoader:e,builtInPlugins:t}=window.markmap;e.transformPlugins=t.filter(e=>e.name!=="prism")}}}</script><script src=https://cdn.jsdelivr.net/npm/markmap-autoloader></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/mhchem.min.js crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js crossorigin=anonymous onload=renderMathInElement(document.body,null)></script><script src=https://cdn.jsdelivr.net/npm/mermaid@latest/dist/mermaid.min.js crossorigin=anonymous></script><script src=/js/main.min.beed1be94ebe04a73a3d983583046daf3fd8ac54857fa72d94a1e83c470d9eaf.js integrity="sha256-vu0b6U6+BKc6PZg1gwRtrz/YrFSFf6ctlKHoPEcNnq8=" crossorigin=anonymous></script></body></html>